<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperFlash Execution Terminal</title>
    <style>
        :root {
            --bg: #0d1117;
            --card-bg: #161b22;
            --border: #30363d;
            --accent: #238636;
            --accent-hover: #2ea043;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --blue: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
        }

        body { background-color: var(--bg); color: var(--text-main); font-family: 'Segoe UI', 'Roboto', monospace; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; display: grid; gap: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--border); font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; color: var(--blue); }

        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
        input, select { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 1rem; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 12px 24px; cursor: pointer; font-size: 1rem; border-radius: 6px; font-weight: 600; transition: all 0.2s; height: 42px; }
        .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }

        /* Log Link Styling */
        .log-link { color: var(--blue); text-decoration: underline; cursor: pointer; }
        
        /* Stepper */
        .stepper { display: flex; justify-content: space-between; margin-top: 20px; position: relative; }
        .step { display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: 1; flex: 1; opacity: 0.4; transition: opacity 0.2s; }
        .step.active { opacity: 1; }
        .step-icon { width: 32px; height: 32px; background: var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--bg); }
        .step.active .step-icon { background: var(--blue); color: white; }
        .step.completed .step-icon { background: var(--green); color: white; }
        .step.error .step-icon { background: var(--red); color: white; }
        .stepper::before { content: ''; position: absolute; top: 16px; left: 10%; right: 10%; height: 2px; background: var(--border); z-index: 0; }

        /* Logs */
        #logs { height: 250px; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9rem; }
        .log-entry { margin-bottom: 6px; padding-left: 10px; border-left: 2px solid transparent; }
        .log-entry.info { border-left-color: var(--blue); }
        .log-entry.success { border-left-color: var(--green); color: var(--green); }
        .log-entry.error { border-left-color: var(--red); color: var(--red); }
        .timestamp { color: var(--border); margin-right: 10px; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° HyperFlash <span style="font-weight:normal; color:var(--text-muted)">Engine</span></h1>
            <span class="badge">‚óè Connected: Railway Cloud</span>
        </header>

        <div class="card">
            <div class="controls">
                <div class="input-group">
                    <label>Pair</label>
                    <select id="pair"><option value="SOL/USDC">SOL / USDC</option></select>
                </div>
                <div class="input-group">
                    <label>Side</label>
                    <select id="side"><option value="BUY">BUY</option><option value="SELL" selected>SELL</option></select>
                </div>
                <div class="input-group">
                    <label>Amount (USDC)</label>
                    <input type="number" id="amount" value="0.01" placeholder="Min 0.001">
                    <div style="font-size:0.7em; color:var(--text-muted)">üí° Try "666" to test Retry Logic</div>
                </div>
                <button id="executeBtn" class="btn" onclick="executeOrder()">üöÄ Execute</button>
            </div>

            <div class="stepper">
                <div class="step" id="step-pending"><div class="step-icon">1</div><div>Queued</div></div>
                <div class="step" id="step-routing"><div class="step-icon">2</div><div>Routing</div></div>
                <div class="step" id="step-submitted"><div class="step-icon">3</div><div>Signing</div></div>
                <div class="step" id="step-confirmed"><div class="step-icon">4</div><div>Settled</div></div>
            </div>
        </div>

        <div class="card">
            <h3>üìú Live Execution Logs</h3>
            <div id="logs"><div class="log-entry">System Ready. Waiting for orders...</div></div>
        </div>
    </div>

    <script>
        // FIX: Removed global 'ws' variable so each order is independent

        async function executeOrder() {
            const btn = document.getElementById('executeBtn');
            const amount = document.getElementById('amount').value;
            const side = document.getElementById('side').value;

            // UI Feedback
            btn.innerText = "Sending...";
            setTimeout(() => btn.innerText = "üöÄ Execute", 300);
            
            resetStepper(); 
            addLog("init", `üöÄ Submitting ${side} order for ${amount} SOL...`);

            try {
                const response = await fetch('https://order-execution-engine-production-28ef.up.railway.app/orders/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: "MARKET",
                        side: side,
                        inputToken: "USDC",
                        outputToken: "SOL",
                        amount: Number(amount)
                    })
                });

                const data = await response.json();
                
                if(data.success) {
                    addLog("info", `Order Queued: ID ${data.orderId}`);
                    updateStepper('pending');
                    // Call connection logic specifically for this ID
                    connectWebSocket(data.orderId);
                } else {
                    addLog("error", `Submission Error: ${data.error}`);
                }
            } catch (e) {
                addLog("error", `API Connection Failed: ${e.message}`);
            }
        }

        function connectWebSocket(orderId) {
            // FIX: Create a LOCAL WebSocket instance for this specific order
            const ws = new WebSocket(`wss://order-execution-engine-production-28ef.up.railway.app/orders/ws?id=${orderId}`);

            ws.onopen = () => { /* Connected */ };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const status = data.status;

                // Only update stepper for the most recent activity (prevents visual flickering)
                updateStepper(status);

                if (status === 'confirmed') {
                    let logMsg = `[CONFIRMED] Swap Success!`;
                    if (data.link) {
                        // Add clickable link directly to logs
                        logMsg += ` <a href="${data.link}" target="_blank" style="color:#58a6ff">View on Explorer ‚Üó</a>`;
                    }
                    // Pass 'true' to render as HTML
                    addLog("success", logMsg, true);
                    ws.close();
                } 
                else if (status === 'failed') {
                    addLog("error", `[FAILED] ${data.log || 'Trade Failed'}`);
                    document.getElementById('step-confirmed').classList.add('error');
                    ws.close();
                } 
                else {
                    // Normal updates
                    addLog("info", `[${status.toUpperCase()}] ${data.log || ''}`);
                }
            };
        }

        // Helper UI Functions
        function updateStepper(status) {
            const stages = ['pending', 'routing', 'submitted', 'confirmed'];
            const idx = stages.indexOf(status);
            if (idx === -1) return;

            stages.forEach((stage, index) => {
                const el = document.getElementById(`step-${stage}`);
                if (index <= idx) {
                    el.classList.add('active');
                    if (index < idx) el.classList.add('completed');
                }
            });
        }

        function resetStepper() {
            document.querySelectorAll('.step').forEach(el => el.className = 'step');
        }

        function addLog(type, message, isHtml = false) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString();
            
            if (isHtml) {
                entry.innerHTML = `<span class="timestamp">${time}</span>${message}`;
            } else {
                const cleanMsg = message.replace(/<[^>]*>?/gm, '');
                entry.innerHTML = `<span class="timestamp">${time}</span>${cleanMsg}`;
            }
            
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
    </script>
</body>
</html>